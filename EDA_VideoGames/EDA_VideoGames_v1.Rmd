---
title: "EDA Video Games"
author: 'Jeremiah Wang'
date: "November 2020"
output:
  html_document:
    theme: simplex
    highlight: pygments
    code_folding: hide
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    toc_depth: 2
    df_print: paged
---

```{r}
#https://datatables.net/reference/option/
options(DT.options = list(scrollX = TRUE, pagin=TRUE, fixedHeader = TRUE, searchHighlight = TRUE))
```

```{r include=FALSE}
library(DataExplorer);library(data.table);library(dlookr);
library(extrafont);library(formattable);library(funModeling);
library(GGally);library(here);
library(janitor);library(lubridate);library(naniar);
library(PerformanceAnalytics);
library(plotly);library(RColorBrewer);library(readxl);
library(skimr);library(tidyverse);library(scales);library(visdat)
```


# Intro
[Kaggle](https://www.kaggle.com/gregorut/videogamesales)

# Get and Split Data
```{r}
a = read_csv('vgsales.csv') %>% 
  clean_names() %>% 
  mutate(across(where(is.character), factor)) %>% 
  select(sort(tidyselect::peek_vars())) %>% 
  mutate(name = as.character(name)) %>% 
  select(
    where(is.Date),
    where(is.factor),
    where(is_character),
    where(is_numeric)
  )

a %>% sample_n(10)
```

# 5minEDA

## Data Dict

```{r eval=FALSE}
Rank - Ranking of overall sales

Name - The games name

Platform - Platform of the games release (i.e. PC,PS4, etc.)

Year - Year of the game's release

Genre - Genre of the game

Publisher - Publisher of the game

NA_Sales - Sales in North America (in millions)

EU_Sales - Sales in Europe (in millions)

JP_Sales - Sales in Japan (in millions)

Other_Sales - Sales in the rest of the world (in millions)

Global_Sales - Total worldwide sales.
```

### check type and missing data
```{r}
a %>% visdat::vis_dat()
```
### check type and missing, na, inf data
```{r}
a %>% funModeling::status()
```


```{r}
a %>% glimpse
```

```{r}
a %>% skim_without_charts()
```

# Wrangling/Cleaning

```{r}
#collapsing/lumping factors with numerous levels
a = a %>% mutate(
  genre = fct_lump_prop(genre, prop = 0.03),
  platform = fct_lump_prop(platform, prop = 0.03),
  publisher = fct_lump_prop(publisher, prop = 0.03)
)
```


# EDA: nom vars

### vector of nom var names
```{r}
(nom.vars = a %>% select(where(is.factor), -rank) %>% colnames %>% as.character)
```

### check missing values
```{r}
a %>% select(nom.vars) %>% miss_var_summary
```

### sample data
```{r}
a %>% select(nom.vars) %>% sample_n(5)
```

### glimpse structure
```{r}
a %>% select(nom.vars) %>% glimpse
```



### distribution of level counts per factor
```{r fig.width=12, fig.height=9}
jpal = viridis::viridis(25)

a %>% select(nom.vars) %>% map_df(n_unique) %>% pivot_longer(everything()) %>% plot_ly(x = ~value, y = ~name, color = ~name, colors = jpal)
a %>% select(nom.vars) %>% funModeling::freq() #there's the option to NOT plot if you want only the data
```

### Mosaic Plots: ggpairs
```{r fig.width=12, fig.height=9}
#documentation: https://mran.microsoft.com/snapshot/2016-01-12/web/packages/GGally/vignettes/ggpairs.html

top.3.publishers = a %>% count(publisher) %>% arrange(-n) %>% head(3) %>% pull(publisher) %>% as.character

top.5.platforms = a %>% count(platform) %>% arrange(-n) %>% head(5) %>% pull(platform) %>% as.character

a %>% filter(
  publisher %in% top.3.publishers,
  platform %in% top.5.platforms
  ) %>%
  mutate(
    publisher = droplevels(publisher),
    platform = droplevels(platform)
    ) %>% 
  select(nom.vars) %>% 
  GGally::ggpairs(
    columns = c('publisher', 'platform'),
    mapping = aes(color = publisher)
)


```

# EDA: num vars

### vector of numeric vars names
```{r}
(numeric.vars = a %>% select(where(is.numeric), -rank) %>% colnames %>% as.character)
```

### check missing values
```{r}
a %>% select(numeric.vars) %>% miss_var_summary
```

### sample data
```{r}
a %>% select(numeric.vars) %>% sample_n(5)
```

### glimpse structure
```{r}
a %>% select(numeric.vars) %>% glimpse
```


### viz: distribution
```{r}
a %>% select(numeric.vars, -rank) %>% DataExplorer::plot_histogram(
  scale_x = 'log10',
  #geom_histogram_args = list(bins = 50L),
  ncol = 1, nrow = 1
)
```

```{r}
a %>% select(numeric.vars, -rank) %>% DataExplorer::plot_density(
  scale_x = 'log10',
  #geom_histogram_args = list(bins = 50L),
  ncol = 1, nrow = 1
)
```

### viz: outliers
```{r}
a %>% select(numeric.vars, -rank) %>% dlookr::plot_outlier()
```

### viz: normality
```{r}
a %>% select(numeric.vars) %>% dlookr::plot_normality()
```

### correlations: viz
```{r fig.width= 12, fig.height=9}
a %>% select(numeric.vars) %>% dlookr::plot_correlate()

a %>% select(where(is.numeric)) %>% GGally::ggcorr(palette = "RdBu", label = TRUE)
```

# EDA: Multi-Variate Analysis

```{r}
target.var = 'global_sales'
```

### correlation w/target var: R stat (Pearson)
```{r}
a %>% select(numeric.vars) %>% funModeling::correlation_table(target = target.var)
```

### correlation w/target var: info theory stats
```{r cache=TRUE}
var.imp = a %>% slice_sample(prop = 0.20) %>%  funModeling::var_rank_info(target = target.var)

# gr = gain ratio
var.imp %>% ggplot(aes(
  y = reorder(var, gr),
  x = gr,
  fill = var
  )) + 
  geom_col() +
  theme_light()
  xlab("") + 
  ylab("Var Importance 
       (based on Information Gain)"
       ) + 
  guides(fill = FALSE)
```

### cross_plot: Distribution plot between input and target variable
```{r}
### much more useful when outcome var is a true binary var
a %>% mutate(
  global_sales.gte.95.ptile.flag = if_else(
    global_sales > as.numeric(quantile(a$global_sales, 0.95)), 'yes', 'no')
  ) %>%
    funModeling::cross_plot(
  input = numeric.vars[c(1,3,4)],
  target = "global_sales.gte.95.ptile.flag"
  )

```

Translation:
1. for the jp_sales viz, of all games in the top quintile of jp sales, 21% of that subset were had global sales in the top 95th ptile or higher.

### cross_plot: Distribution plot between input and target variable
```{r fig.width=12, fig.height=9}
### much more useful when outcome var is a true binary var
a %>% mutate(
  global_sales.gte.95.ptile.flag = if_else(
    global_sales > as.numeric(quantile(a$global_sales, 0.95)), 'yes', 'no')
  ) %>%
    funModeling::cross_plot(
  input = nom.vars[1:3],
  target = "global_sales.gte.95.ptile.flag"
  )

#translation: for the jp_sales viz, of all games in the top quintile of jp sales, 21% of that subset were had global sales in the top 95th ptile or higher.
```

Translation:
1. Among the smaller subset of all platform games, 9.5% were in the larger subset of games that were in the 95th ptile or higher of global sales
2. Among the smaller subset of all Xbpx 360 games, 8.9% were in the larger subset of games that were in the 95th ptile or higher of global sales
3. Among the smaller subset of all Nintendo games, 28.2% were in the larger subset of games that were in the 95th ptile or higher of global sales

```{r}
top.3.publishers = a %>% count(publisher) %>% arrange(-n) %>% head(3) %>% pull(publisher) %>% as.character

top.5.platforms = a %>% count(platform) %>% arrange(-n) %>% head(5) %>% pull(platform) %>% as.character
```


### plotar: Boxplot and density histogram between input and target variables
```{r}
plotar(data=mtcars, input = "gear", target="cyl", plot_type="histdens")

#if the curves are spaced apart, then the input var is a better predictor of the target var
```
### categ_analysis: Quantitative analysis for binary outcome
```{r}
#This function is used to analyze data when we need to reduce variable cardinality in predictive modeling.
#works in conjunction with 'cross_plot'; (e.g. 28 percent of Nintendo games made in in the subset of games in the 95th ptile of global sales or higher)

a %>% mutate(
  global_sales.gte.95.ptile.flag = if_else(
    global_sales > as.numeric(quantile(a$global_sales, 0.95)), 'yes', 'no')
  ) %>% funModeling::categ_analysis(
    input = 'publisher',
    target = 'global_sales.gte.95.ptile.flag'
  )

```

# OPTIONAL Data Prep

### discretization: num > nom
```{r}
#https://cran.r-project.org/web/packages/funModeling/vignettes/funModeling_quickstart.html
#discretize_get_bins + discretize_df: Convert numeric variables to categoric

(data.bins =  a %>% funModeling::discretize_get_bins(input = numeric.vars, n_bins = 20))

a %>% funModeling::discretize_df(data_bins = data.bins, stringsAsFactors = TRUE) %>% select(numeric.vars)
```

### outlier handling: prep_outliers
```{r}
#https://livebook.datascienceheroes.com/data-preparation.html#detecting-outliers-using-tukey-method

a %>% select(numeric.vars) %>% map(.x = . , ~tukey_outlier(.x)) %>%
  as.data.frame.list() %>% rownames_to_column(var = 'tukey_outlier')

a %>% funModeling::prep_outliers(
  input = numeric.vars,
  method = 'tukey',
  type='stop'
  )
```