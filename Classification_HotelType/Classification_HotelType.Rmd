---
title: "Predicting Hotel Type and Booking Demand"
author: 'Jeremiah Wang'
date: "November 2020"
output:
  html_document:
    theme: simplex
    highlight: pygments
    code_folding: hide
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    toc_depth: 2
    df_print: paged
---

```{r}
#https://datatables.net/reference/option/
options(DT.options = list(scrollX = TRUE, pagin=TRUE, fixedHeader = TRUE, searchHighlight = TRUE))
```

```{r include=FALSE}
library(DataExplorer);library(data.table);library(dlookr);
library(extrafont);library(formattable);library(GGally);library(here);
library(janitor);library(lubridate);library(naniar);
library(PerformanceAnalytics);
library(plotly);library(RColorBrewer);library(readxl);
library(skimr);library(tidyverse);library(scales)

library(tidymodels);library(h2o)
```

# Introduction

[Check out this Kaggle](https://www.kaggle.com/jessemostipak/hotel-booking-demand)

# Business Goals

1. Predict the number of bookings for resort and city for the next 4 weeks
2. Determine if we can classify a booking as a resort or city type
3. Predict adr prices based on other features

# Ideas

1. logistic regression / random forests
2. fb's prophet package
3. elastic net, random forest, regression

# Get Data

```{r message=FALSE}
a = read_csv('hotel_bookings.csv') %>%
  clean_names() %>% 
  mutate(across(where(is.character), factor)) %>% 
  select(sort(tidyselect::peek_vars())) %>% 
  select(
    where(is.Date),
    where(is.factor),
    where(is.numeric)
  ) %>% filter(is_canceled == 0) #filter to non-canceled bookings

a$is_canceled = NULL
```

# Split Data

```{r}
split = initial_split(a)
train = rsample::training(split)
test = rsample::testing(split)
```


# Resources

1. adr
    + https://www.xotels.com/en/glossary/adr-average-daily-rate/
2. transient
    + https://www.xotels.com/en/glossary/transient/
3. group rate
    + https://www.xotels.com/en/glossary/group-rate/
4. Guide to Hotel Management
    + https://www.4hoteliers.com/features/article/9886
5. distribution channels
    + https://www.xotels.com/en/glossary/channels/

## 5 min EDA

```{r}
train %>% head
```

```{r}
skimr::skim(train)
```

### clean/encode data
```{r}
# make arrival date col
train = train %>% mutate(
  arrival.date = make_date(
    year = arrival_date_year,
    month = match(arrival_date_month, month.name),
    day = arrival_date_day_of_month)
  )

# these numeric vars s/b factor vars
train = train %>% mutate_at(vars(arrival_date_day_of_month, arrival_date_week_number, arrival_date_year, is_repeated_guest), factor)

# reordering df
train = train %>% select(sort(tidyselect::peek_vars())) %>% 
  select(
    where(is.Date),
    where(is.factor),
    where(is.numeric)
  )

```


# EDA: time series

Note: not a true time series in that the arrival month is a factor

### range
```{r}
paste(
  'The date range of this dataset is from',
  train %>% pull(arrival.date) %>% range %>% .[1],
  'to',
  train %>% pull(arrival.date) %>% range %>% .[2]
)
```

### time series count graph -- ungrouped
```{r message=FALSE, warning=FALSE}
train %>% group_by(arrival.date) %>% 
  summarise(total.bookings = sum(adults, children)) %>% 
  arrange(arrival.date) %>%
  plot_ly(
    x = ~arrival.date,
    y = ~total.bookings
  ) %>% layout(
    title = 'total.bookings by date',
    xaxis = list(title = ''),
    yaxis = list(title = '')
    )
```

### time series count graph -- grouped (hotel)
```{r message=FALSE, warning=FALSE}
train %>% group_by(arrival.date, hotel) %>%
  summarise(count = n()) %>% 
  arrange(arrival.date) %>%
  plot_ly(
    x = ~arrival.date,
    y = ~count,
    color = ~hotel,
    alphtrain = 0.7
  )  %>% layout(
    title = 'total.bookings by date/hotel',
    xaxis = list(title = ''),
    yaxis = list(title = '')
    ) 
```

### time series count graph -- grouped (customer_type)
```{r message=FALSE, warning=FALSE}
train %>% group_by(arrival.date, customer_type) %>%
  summarise(count = n()) %>% 
  arrange(arrival.date) %>%
  plot_ly(
    x = ~arrival.date,
    y = ~count,
    color = ~customer_type,
    alphtrain = 0.7
  ) %>% layout(
    title = 'total.bookings by date/customer_type',
    xaxis = list(title = ''),
    yaxis = list(title = '')
    )
```

### time series count graph -- grouped (deposit_type)
```{r message=FALSE, warning=FALSE}
train %>% group_by(arrival.date, deposit_type) %>%
  summarise(count = n()) %>% 
  arrange(arrival.date) %>%
  plot_ly(
    x = ~arrival.date,
    y = ~count,
    color = ~deposit_type,
    alphtrain = 0.7
  ) %>% layout(
    title = 'total.bookings by date/deposit_type',
    xaxis = list(title = ''),
    yaxis = list(title = '')
    )
```

### time series count graph -- grouped (distribution_channel)
```{r message=FALSE, warning=FALSE}
train %>% group_by(arrival.date, distribution_channel) %>%
  summarise(count = n()) %>% 
  arrange(arrival.date) %>%
  plot_ly(
    x = ~arrival.date,
    y = ~count,
    color = ~distribution_channel,
    alphtrain = 0.7
  ) %>% layout(
    title = 'total.bookings by date/distribution_channel',
    xaxis = list(title = ''),
    yaxis = list(title = '')
    )
```

# EDA: nom vars

### sample data
```{r}
train %>% select(where(is.factor)) %>% slice_sample(n = 10)
```

### glimpse structure
```{r}
train %>% select(where(is.factor)) %>% glimpse
```

### check missing values
```{r}
train %>% select(where(is.factor)) %>% miss_var_summary
```

### distribution of level counts per factor
```{r warning=FALSE}
jpal = colorRampPalette(brewer.pal(8,'Dark2'))(15)

train %>% select(where(is.factor)) %>%
  map(n_unique) %>%
  as.tibble() %>%
  pivot_longer(everything()) %>%
  plot_ly(y = ~name, x = ~value, color = ~name, colors = jpal) %>%
  add_bars() %>%
  hide_legend() %>% 
  layout(
    title = 'distribution of level counts per factor',
    xaxis = list(title = ''),
    yaxis = list(title = '')
    )
```

### reference: names of unique levels
```{r}
train %>% select(where(is.factor)) %>%
  map(unique)

train = train %>% mutate(arrival_date_month = factor(arrival_date_month, levels = c('January','February','March','April','May','June','July','August','September','October','November','December')))
```

# EDA: num vars

### check missing values
```{r}
train %>% select(where(is.numeric)) %>% miss_var_summary
```

### sample data
```{r}
train %>% select(where(is.numeric)) %>% slice_sample(n = 10)
```

### glimpse structure
```{r}
train %>% select(where(is.numeric)) %>% glimpse
```


### viz: outliers
```{r}
train %>% select(where(is.numeric)) %>% dlookr::plot_outlier()
```

<h style="color: red; font-size:18px;">There are many upper outliers.  When building a prediction model, perhaps we should consider transforming them or removing them entirely.</h>

### check right tailness
```{r}
jquantiles = function(col){quantile(col, probs = c(0.90, 0.95, 0.99, 1))}

train %>% na.omit %>% select(where(is.numeric)) %>%
  map(.x = . , jquantiles) %>%
  as.data.frame.list() %>%
  rownames_to_column() %>%
  as.tibble()

```

### viz: normality
```{r}
train %>% select(where(is.numeric)) %>% dlookr::plot_normality()
```

### viz: distribution histogram
```{r}
#with outliers
train %>% select(where(is.numeric)) %>% DataExplorer::plot_histogram(nrow = 2, ncol = 1)
```

```{r}
#no outliers
train %>% select(where(is.numeric)) %>% filter(
  adr != 5400,
  adults != 55,
  babies != 10,
  booking_changes != 21,
  children != 10,
  days_in_waiting_list != 391,
  lead_time != 709,
  previous_bookings_not_canceled != 72,
  previous_cancellations != 26,
  required_car_parking_spaces != 8,
  stays_in_week_nights != 50,
  stays_in_weekend_nights != 19
) %>% DataExplorer::plot_histogram(nrow = 2, ncol = 1)
```


### viz: distribution bivariate
```{r}
#no outliers
train %>% select(hotel, where(is.numeric)) %>% filter(
  adr != 5400,
  adults != 55,
  babies != 10,
  booking_changes != 21,
  children != 10,
  days_in_waiting_list != 391,
  lead_time != 709,
  previous_bookings_not_canceled != 72,
  previous_cancellations != 26,
  required_car_parking_spaces != 8,
  stays_in_week_nights != 50,
  stays_in_weekend_nights != 19
) %>% DataExplorer::plot_boxplot(by = 'hotel', nrow = 3, ncol = 1)
```

# EDA: ADR further investigation

<h style="color: red; font-size:18px;">You should calculate ADR per adult since the ds is at the booking level not individual level</h>

```{r warning=FALSE}
#looks like one outlier in adr is changing the scale, making it hard to see the true distribution --remove outlier

train %>% filter(adr != 5400) %>%
  select(hotel, adr) %>%
  plot_ly(y = ~hotel, x = ~adr, color = ~hotel, colors = jpal[1:2]) %>% 
  add_boxplot()

#https://stackoverflow.com/questions/57300053/split-a-plotly-boxplot-x-axis-by-group
train %>% filter(adr != 5400) %>%
  select(hotel, adr, customer_type) %>%
  plot_ly(y = ~hotel, x = ~adr, color = ~customer_type, colors = jpal, group = ~customer_type) %>% 
  add_boxplot() %>% 
  layout(
    boxmode = 'group', #SUPER IMPORTANT
    title = 'ADR by Hotel/customer_type'
    ) 

#https://stackoverflow.com/questions/57300053/split-a-plotly-boxplot-x-axis-by-group
train %>% filter(adr != 5400) %>%
  select(hotel, adr, market_segment) %>%
  plot_ly(y = ~hotel, x = ~adr, color = ~market_segment, colors = jpal, group = ~market_segment) %>% 
  add_boxplot() %>% 
  layout(
    boxmode = 'group', #SUPER IMPORTANT
    title = 'ADR by Hotel/market_segment'
    ) 

#https://stackoverflow.com/questions/57300053/split-a-plotly-boxplot-x-axis-by-group
train %>% filter(adr != 5400) %>%
  select(hotel, adr, arrival_date_month) %>%
  plot_ly(x = ~hotel, y = ~adr, color = ~arrival_date_month, colors = jpal, group = ~arrival_date_month) %>% 
  add_boxplot() %>% 
  layout(
    boxmode = 'group', #SUPER IMPORTANT
    title = 'ADR by Hotel/arrival_date_month'
    ) 

library(DescTools)

ggplotly(
train %>% filter(adr != 5400) %>% 
  mutate(arrival_date_month = factor(arrival_date_month, labels = DescTools::StrLeft(levels(a$arrival_date_month), 3))) %>% 
  group_by(arrival_date_month, hotel) %>% 
  summarise(med.adr = median(adr, na.rm = TRUE)) %>% 
  ggplot(aes(arrival_date_month, med.adr, fill = hotel)) +
  geom_col(position = 'dodge') +
  scale_fill_manual(values = c('blue4','darkorange'))
) %>% layout(
  title = 'Median ADR by Hotel/Month'
)
  
```

### correlations: viz
```{r}
train %>% select(where(is.numeric)) %>% dlookr::plot_correlate()
train %>% select(where(is.numeric)) %>% GGally::ggcorr(palette = "RdBu", label = TRUE)
```

```{r}

```

# Goal 1: Predict Number of Bookings by Hotel Type

## Anomaly Detection
```{r warning=FALSE, message=FALSE}
library(anomalize)
# time_decompose(data, target, method = c("stl", "twitter"), frequency = "auto", trend = "auto", ..., merge = FALSE, message = TRUE)
# anomalize(data, target, method = c("iqr", "gesd"), alpha = 0.05, max_anoms = 0.2, verbose = FALSE)
# The alpha parameter adjusts the width of the critical values. By default, alpha = 0.05.
# Lower values are more conservative while higher values are less prone to incorrectly classifying "normal" observations.
# max_anoms: The maximum percent of anomalies permitted to be identified.

# The STL method uses the stl() function from the stats package. STL works very well in circumstances where a long term trend is present (which applies in this case; see trend component in the prophet graphs below'). 
  
#use full data set, filter to hotel type, arrange by date
a1 = a %>% mutate(
  arrival.date = make_date(
    year = arrival_date_year,
    month = match(arrival_date_month, month.name),
    day = arrival_date_day_of_month)
  )

(anomaly.hotel.resort = a1 %>% filter(hotel == 'Resort Hotel') %>% 
  group_by(arrival.date, hotel) %>% 
  summarise(total.bookings = sum(adults, children)) %>% 
  select(arrival.date, hotel, total.bookings) %>% 
  arrange(arrival.date) %>% as.tibble() %>% 
  time_decompose(total.bookings, method = 'stl', merge = TRUE) %>%
  anomalize(remainder, alpha = 0.15, method = 'gesd') %>% #increasing sensitivity to outliers
  time_recompose())

(anomaly.hotel.city = a1 %>% filter(hotel == 'City Hotel') %>% 
  group_by(arrival.date, hotel) %>% 
  summarise(total.bookings = sum(adults, children)) %>% 
  select(arrival.date, hotel, total.bookings) %>% 
  arrange(arrival.date) %>% as.tibble() %>% 
  time_decompose(total.bookings, method = 'stl', merge = TRUE) %>%
  anomalize(remainder, alpha = 0.15, method = 'gesd') %>% #increasing sensitivity to outliers
  time_recompose())

ggplotly(
  anomaly.hotel.resort %>% 
    plot_anomalies(
      ncol = 2,
      alpha_dots = 0.5,
      alpha_circles = 0.5,
      size_circles = 2,
      time_recomposed = TRUE,
      alpha_ribbon = 0.05
      ) + scale_y_continuous(labels = comma) +
    labs(x = '', y = 'total.bookings', title = 'resort hotel total.bookings')
  )

ggplotly(
  anomaly.hotel.city %>% 
    plot_anomalies(
      ncol = 2,
      alpha_dots = 0.5,
      alpha_circles = 0.5,
      size_circles = 2,
      time_recomposed = TRUE,
      alpha_ribbon = 0.05
      ) + scale_y_continuous(labels = comma) +
    labs(x = '', y = 'total.bookings', title = 'city hotel total.bookings')
  )
  

```

## Predicting Next 2 Wks Total Bookings

### Resort Hotel
```{r warning=FALSE, message=FALSE}
library(prophet)
library(dygraphs)
# https://dygraphs.com/options.html

#renaming cols to prophet's col conventions
prophet.resort.df = anomaly.hotel.resort %>% select(ds = arrival.date, y = total.bookings)

#creating model
prophet.resort.mdl = prophet.resort.df %>% prophet()

#using model make future period df
prophet.resort.future.df = prophet.resort.mdl %>% make_future_dataframe(
  periods = 28, #next 4 wks
  freq = 'day',
  include_history = TRUE
  )

#make forecasts df
prophet.resort.forecast.df = prophet.resort.mdl %>% predict(prophet.resort.future.df)

prophet.resort.forecast.df %>% head %>% DT::datatable()

#plot forecast
prophet.resort.mdl %>% dyplot.prophet(
  prophet.resort.forecast.df,
  main = '<h style="color: black; font-size:18px;">Resort Hotel: Total Bookings 1 Month Prediction</h>'
  ) %>%
  dygraphs::dyOptions(
    colors = c('darkorange','blue'),
    pointSize = 2,
    )



#plot forecast components
prophet.resort.mdl %>% prophet_plot_components(prophet.resort.forecast.df)

```

### City Hotel
```{r}
library(prophet)
# https://dygraphs.com/options.html

#renaming cols to prophet's col conventions
prophet.city.df = anomaly.hotel.city %>% select(ds = arrival.date, y = total.bookings)

#creating model
prophet.city.mdl = prophet.city.df %>% prophet()

#using model make future period df
prophet.city.future.df = prophet.city.mdl %>% make_future_dataframe(
  periods = 28, #next 4 wks
  freq = 'day',
  include_history = TRUE
  )

#make forecasts df
prophet.city.forecast.df = prophet.city.mdl %>% predict(prophet.city.future.df)

prophet.city.forecast.df %>% head %>% DT::datatable()

#plot forecast
prophet.city.mdl %>% dyplot.prophet(
  prophet.city.forecast.df,
  main = '<h style="color: black; font-size:18px;">City Hotel: Total Bookings 1 Month Prediction</h>'
  ) %>%
  dygraphs::dyOptions(
    colors = c('darkgreen','blue'),
    pointSize = 2,
    )

#plot forecast components
prophet.city.mdl %>% prophet_plot_components(prophet.city.forecast.df)

```